# Docker Compose for local development
# Run: docker-compose up -d
# Stop: docker-compose down
# Reset data: docker-compose down -v
#
# SECURITY NOTE: Default passwords are used for local development only.
# NEVER use these credentials in production environments.
# Change all passwords before deploying to any shared or production environment.

services:
{{- if and (.HasModule "SQLDatastore") (eq .Database "postgresql")}}
  postgres:
    image: postgres:15-alpine
    container_name: {{.ProjectName}}-postgres
    environment:
      POSTGRES_DB: {{.ProjectName}}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"  # Host:Container - uses 5433 to avoid conflicts with local PostgreSQL
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- else if and (.HasModule "SQLDatastore") (eq .Database "mysql")}}
  mysql:
    image: mysql:8.0
    container_name: {{.ProjectName}}-mysql
    environment:
      MYSQL_DATABASE: {{.ProjectNameSnake}}
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"  # Host:Container - uses 3307 to avoid conflicts with local MySQL
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
    command: --default-authentication-plugin=mysql_native_password
{{- end}}
{{- if and (.HasModule "NoSQLDatastore") (eq .NoSQLDatabase "mongodb")}}
  mongodb:
    image: mongo:7.0
    container_name: {{.ProjectName}}-mongodb
    environment:
      MONGO_INITDB_DATABASE: {{.ProjectName}}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- else if and (.HasModule "NoSQLDatastore") (eq .NoSQLDatabase "redis")}}
  redis:
    image: redis:7-alpine
    container_name: {{.ProjectName}}-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- end}}
{{- /* Kafka for EventConsumer */}}
{{- if and (.HasModule "EventConsumer") (.UsesKafka)}}

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: {{.ProjectName}}-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: {{.ProjectName}}-kafka
    depends_on:
      zookeeper:
        condition: service_started
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 5
{{- end}}
{{- /* RabbitMQ for EventConsumer */}}
{{- if and (.HasModule "EventConsumer") (.UsesRabbitMQ)}}

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: {{.ProjectName}}-rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 10s
      retries: 5
{{- end}}
{{- /* LocalStack for AWS SQS */}}
{{- if and (.HasModule "EventConsumer") (.UsesSQS)}}

  localstack:
    image: localstack/localstack:3.0
    container_name: {{.ProjectName}}-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=sqs
      - DEFAULT_REGION=us-east-1
      - DEBUG=0
    volumes:
      - localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Init container to create SQS queue
  localstack-init:
    image: amazon/aws-cli:latest
    container_name: {{.ProjectName}}-localstack-init
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating SQS queue: placeholder-events"
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name placeholder-events
        echo "SQS initialization complete"
{{- end}}
{{- /* GCP Pub/Sub Emulator */}}
{{- if and (.HasModule "EventConsumer") (.UsesPubSub)}}

  pubsub-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    container_name: {{.ProjectName}}-pubsub-emulator
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085 --project=local-project
    ports:
      - "8085:8085"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Init container to create Pub/Sub topic and subscription
  pubsub-init:
    image: curlimages/curl:latest
    container_name: {{.ProjectName}}-pubsub-init
    depends_on:
      pubsub-emulator:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating Pub/Sub topic: placeholder-events"
        curl -s -X PUT "http://pubsub-emulator:8085/v1/projects/local-project/topics/placeholder-events"
        echo ""
        echo "Creating Pub/Sub subscription: placeholder-events-sub"
        curl -s -X PUT "http://pubsub-emulator:8085/v1/projects/local-project/subscriptions/placeholder-events-sub" \
          -H "Content-Type: application/json" \
          -d '{"topic": "projects/local-project/topics/placeholder-events"}'
        echo ""
        echo "Pub/Sub initialization complete"
{{- end}}
{{- /* PostgreSQL for JobRunr when using Redis (since Redis is deprecated in JobRunr 8+) */}}
{{- if .WorkerNeedsOwnPostgres}}

  # PostgreSQL for JobRunr storage (Redis is deprecated in JobRunr 8+)
  # This is separate from your Redis application data store
  postgres-jobrunr:
    image: postgres:15-alpine
    container_name: {{.ProjectName}}-postgres-jobrunr
    environment:
      POSTGRES_DB: {{.ProjectName}}_jobs
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"  # Different port for JobRunr database
    volumes:
      - postgres_jobrunr_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
{{- end}}

{{- /* Only output volumes section if at least one volume is needed */}}
{{- $needsVolumes := or (or (or (or (.HasModule "SQLDatastore") (.HasModule "NoSQLDatastore")) .WorkerNeedsOwnPostgres) (and (.HasModule "EventConsumer") (.UsesRabbitMQ))) (and (.HasModule "EventConsumer") (.UsesSQS)) }}
{{- if $needsVolumes}}

volumes:
{{- if and (.HasModule "SQLDatastore") (eq .Database "postgresql")}}
  postgres_data:
{{- else if and (.HasModule "SQLDatastore") (eq .Database "mysql")}}
  mysql_data:
{{- end}}
{{- if and (.HasModule "NoSQLDatastore") (eq .NoSQLDatabase "mongodb")}}
  mongodb_data:
{{- else if and (.HasModule "NoSQLDatastore") (eq .NoSQLDatabase "redis")}}
  redis_data:
{{- end}}
{{- if .WorkerNeedsOwnPostgres}}
  postgres_jobrunr_data:
{{- end}}
{{- if and (.HasModule "EventConsumer") (.UsesRabbitMQ)}}
  rabbitmq_data:
{{- end}}
{{- if and (.HasModule "EventConsumer") (.UsesSQS)}}
  localstack_data:
{{- end}}
{{- end}}
