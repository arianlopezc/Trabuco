package {{.GroupID}}.events;

import {{.GroupID}}.model.events.PlaceholderEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
{{- if .UsesKafka}}
import org.springframework.kafka.core.KafkaTemplate;
{{- else if .UsesRabbitMQ}}
import org.springframework.amqp.rabbit.core.RabbitTemplate;
{{- else if .UsesSQS}}
import io.awspring.cloud.sqs.operations.SqsTemplate;
{{- else if .UsesPubSub}}
import com.google.cloud.spring.pubsub.core.PubSubTemplate;
{{- end}}

/**
 * Service for publishing events to the message broker.
 *
 * <p>This service abstracts the message broker implementation,
 * allowing business code to publish events without knowing
 * whether {{if .UsesKafka}}Kafka{{else if .UsesRabbitMQ}}RabbitMQ{{else if .UsesSQS}}AWS SQS{{else if .UsesPubSub}}GCP Pub/Sub{{end}} is being used.</p>
 *
 * <p>Usage:
 * <pre>{@code
 * @Autowired
 * private EventPublisher eventPublisher;
 *
 * <p>public void doSomething() {
 *     // Business logic...
 *     eventPublisher.publish(PlaceholderCreatedEvent.create(id, name));
 * }
 * }</pre>
 * </p>
 */
@Service
public class EventPublisher {

  private static final Logger logger = LoggerFactory.getLogger(EventPublisher.class);
{{if .UsesKafka}}
  private final KafkaTemplate<String, Object> kafkaTemplate;

  @Value("${app.kafka.topics.placeholder-events:placeholder-events}")
  private String placeholderTopic;

  public EventPublisher(KafkaTemplate<String, Object> kafkaTemplate) {
    this.kafkaTemplate = kafkaTemplate;
  }

  /**
   * Publishes a PlaceholderEvent to Kafka.
   *
   * <p>The event ID is used as the message key to ensure
   * events for the same entity go to the same partition.</p>
   *
   * @param event The event to publish
   */
  public void publish(PlaceholderEvent event) {
    logger.info("Publishing event to Kafka: topic={}, eventId={}, type={}",
      placeholderTopic, event.eventId(), event.getClass().getSimpleName());
    kafkaTemplate.send(placeholderTopic, event.eventId(), event);
  }
{{else if .UsesRabbitMQ}}
  private final RabbitTemplate rabbitTemplate;

  @Value("${app.rabbitmq.exchanges.placeholder:placeholder-exchange}")
  private String placeholderExchange;

  public EventPublisher(RabbitTemplate rabbitTemplate) {
    this.rabbitTemplate = rabbitTemplate;
  }

  /**
   * Publishes a PlaceholderEvent to RabbitMQ.
   *
   * <p>Events are published to the configured exchange with
   * an empty routing key (fanout behavior).</p>
   *
   * @param event The event to publish
   */
  public void publish(PlaceholderEvent event) {
    logger.info("Publishing event to RabbitMQ: exchange={}, eventId={}, type={}",
      placeholderExchange, event.eventId(), event.getClass().getSimpleName());
    rabbitTemplate.convertAndSend(placeholderExchange, "", event);
  }
{{else if .UsesSQS}}
  private final SqsTemplate sqsTemplate;

  @Value("${app.sqs.queue.placeholder-events:placeholder-events}")
  private String placeholderQueue;

  public EventPublisher(SqsTemplate sqsTemplate) {
    this.sqsTemplate = sqsTemplate;
  }

  /**
   * Publishes a PlaceholderEvent to AWS SQS.
   *
   * <p>Events are sent to the configured queue.
   * SQS provides automatic message durability and delivery guarantees.</p>
   *
   * @param event The event to publish
   */
  public void publish(PlaceholderEvent event) {
    logger.info("Publishing event to SQS: queue={}, eventId={}, type={}",
      placeholderQueue, event.eventId(), event.getClass().getSimpleName());
    sqsTemplate.send(placeholderQueue, event);
  }
{{else if .UsesPubSub}}
  private final PubSubTemplate pubSubTemplate;

  @Value("${app.pubsub.topic.placeholder-events:placeholder-events}")
  private String placeholderTopic;

  public EventPublisher(PubSubTemplate pubSubTemplate) {
    this.pubSubTemplate = pubSubTemplate;
  }

  /**
   * Publishes a PlaceholderEvent to GCP Pub/Sub.
   *
   * <p>Events are published to the configured topic.
   * Pub/Sub provides at-least-once delivery semantics.</p>
   *
   * @param event The event to publish
   */
  public void publish(PlaceholderEvent event) {
    logger.info("Publishing event to Pub/Sub: topic={}, eventId={}, type={}",
      placeholderTopic, event.eventId(), event.getClass().getSimpleName());
    pubSubTemplate.publish(placeholderTopic, event);
  }
{{end}}
}
