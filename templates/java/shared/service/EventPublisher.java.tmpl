package {{.GroupID}}.shared.service;

import {{.GroupID}}.events.placeholder.PlaceholderEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
{{- if .UsesKafka}}
import org.springframework.kafka.core.KafkaTemplate;
{{- else if .UsesRabbitMQ}}
import org.springframework.amqp.rabbit.core.RabbitTemplate;
{{- end}}

/**
 * Service for publishing events to the message broker.
 *
 * <p>This service abstracts the message broker implementation,
 * allowing business code to publish events without knowing
 * whether Kafka or RabbitMQ is being used.</p>
 *
 * <p>Usage in services:
 * <pre>{@code
 * @Autowired
 * private EventPublisher eventPublisher;
 *
 * public void doSomething() {
 *     // Business logic...
 *     eventPublisher.publish(PlaceholderCreatedEvent.create(id, name));
 * }
 * }</pre>
 * </p>
 */
@Service
public class EventPublisher {

    private static final Logger logger = LoggerFactory.getLogger(EventPublisher.class);
{{if .UsesKafka}}
    private final KafkaTemplate<String, Object> kafkaTemplate;

    @Value("${app.kafka.topics.placeholder-events:placeholder-events}")
    private String placeholderTopic;

    public EventPublisher(KafkaTemplate<String, Object> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    /**
     * Publishes a PlaceholderEvent to Kafka.
     *
     * <p>The event ID is used as the message key to ensure
     * events for the same entity go to the same partition.</p>
     *
     * @param event The event to publish
     */
    public void publish(PlaceholderEvent event) {
        logger.info("Publishing event to Kafka: topic={}, eventId={}, type={}",
            placeholderTopic, event.eventId(), event.getClass().getSimpleName());
        kafkaTemplate.send(placeholderTopic, event.eventId(), event);
    }
{{else if .UsesRabbitMQ}}
    private final RabbitTemplate rabbitTemplate;

    @Value("${app.rabbitmq.exchanges.placeholder:placeholder-exchange}")
    private String placeholderExchange;

    public EventPublisher(RabbitTemplate rabbitTemplate) {
        this.rabbitTemplate = rabbitTemplate;
    }

    /**
     * Publishes a PlaceholderEvent to RabbitMQ.
     *
     * <p>Events are published to the configured exchange with
     * an empty routing key (fanout behavior).</p>
     *
     * @param event The event to publish
     */
    public void publish(PlaceholderEvent event) {
        logger.info("Publishing event to RabbitMQ: exchange={}, eventId={}, type={}",
            placeholderExchange, event.eventId(), event.getClass().getSimpleName());
        rabbitTemplate.convertAndSend(placeholderExchange, "", event);
    }
{{end}}
}
