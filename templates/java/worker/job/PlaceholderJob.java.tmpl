package {{.GroupID}}.worker.job;

import org.jobrunr.jobs.annotations.Job;
import org.jobrunr.scheduling.JobScheduler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.List;

/**
 * Example job service demonstrating all JobRunr job types.
 *
 * JobRunr supports four types of jobs:
 *
 * 1. Fire-and-Forget: Execute immediately in background
 *    jobScheduler.enqueue(() -> placeholderJob.executeFireAndForget("data"));
 *
 * 2. Delayed: Execute at a specific time in the future
 *    jobScheduler.schedule(Instant.now().plusHours(1), () -> placeholderJob.executeDelayed("data"));
 *
 * 3. Recurring: Execute on a schedule (CRON)
 *    jobScheduler.scheduleRecurrently("job-id", Cron.daily(), () -> placeholderJob.executeRecurringJob("data"));
 *
 * 4. Batch: Process multiple items efficiently
 *    jobScheduler.enqueue(items.stream(), item -> placeholderJob.executeBatchItem(item));
 *
 * All jobs are:
 * - Persisted to database (survives restarts)
 * - Automatically retried on failure (10 times with exponential backoff)
 * - Distributed across Worker instances
 * - Visible in JobRunr dashboard at http://localhost:8000
 */
@Service
public class PlaceholderJob {

    private static final Logger log = LoggerFactory.getLogger(PlaceholderJob.class);

    private final JobScheduler jobScheduler;

    public PlaceholderJob(JobScheduler jobScheduler) {
        this.jobScheduler = jobScheduler;
    }

    // ============================================
    // Job Methods (called by JobRunr)
    // ============================================

    /**
     * Fire-and-forget job example.
     * Use this pattern for tasks that should run immediately in the background.
     *
     * @param message The message to process
     */
    @Job(name = "Fire-and-forget: %0")
    public void executeFireAndForget(String message) {
        log.info("Executing fire-and-forget job with message: {}", message);

        // Simulate some work
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        log.info("Fire-and-forget job completed: {}", message);
    }

    /**
     * Delayed job example.
     * Use this pattern for tasks that should run at a specific time.
     *
     * @param message The message to process
     */
    @Job(name = "Delayed: %0")
    public void executeDelayed(String message) {
        log.info("Executing delayed job with message: {}", message);
        log.info("Delayed job completed: {}", message);
    }

    /**
     * Recurring job example.
     * Use this pattern for tasks that run on a schedule (CRON).
     *
     * @param message The message to process
     */
    @Job(name = "Recurring: %0")
    public void executeRecurringJob(String message) {
        log.info("Executing recurring job with message: {}", message);
        log.info("Recurring job completed: {}", message);
    }

    /**
     * Batch job item example.
     * Use this pattern for processing multiple items efficiently.
     *
     * @param itemId The item ID to process
     */
    @Job(name = "Batch item: %0")
    public void executeBatchItem(String itemId) {
        log.info("Processing batch item: {}", itemId);
        log.info("Batch item completed: {}", itemId);
    }

    // ============================================
    // Helper Methods (for enqueuing jobs)
    // ============================================

    /**
     * Enqueue a fire-and-forget job.
     * Call this from other services (e.g., API controllers) to run a job in the background.
     *
     * Example usage from API controller:
     *   @Autowired PlaceholderJob placeholderJob;
     *   placeholderJob.enqueueFireAndForget("process this");
     *
     * @param message The message to process
     */
    public void enqueueFireAndForget(String message) {
        jobScheduler.<PlaceholderJob>enqueue(job -> job.executeFireAndForget(message));
        log.info("Enqueued fire-and-forget job: {}", message);
    }

    /**
     * Schedule a delayed job.
     * Call this to run a job at a specific time in the future.
     *
     * @param message The message to process
     * @param delayMinutes Minutes to wait before executing
     */
    public void scheduleDelayed(String message, long delayMinutes) {
        Instant scheduledTime = Instant.now().plus(delayMinutes, ChronoUnit.MINUTES);
        jobScheduler.<PlaceholderJob>schedule(scheduledTime, job -> job.executeDelayed(message));
        log.info("Scheduled delayed job for {} minutes from now: {}", delayMinutes, message);
    }

    /**
     * Enqueue batch jobs.
     * Call this to process multiple items efficiently.
     *
     * @param itemIds List of item IDs to process
     */
    public void enqueueBatch(List<String> itemIds) {
        jobScheduler.<PlaceholderJob, String>enqueue(itemIds.stream(), PlaceholderJob::executeBatchItem);
        log.info("Enqueued batch of {} items", itemIds.size());
    }
}
