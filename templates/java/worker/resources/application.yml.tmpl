# Worker Module Configuration
# This module handles background job processing using JobRunr

spring:
  application:
    name: {{.ProjectName}}-worker
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:local}
  lifecycle:
    timeout-per-shutdown-phase: ${SHUTDOWN_TIMEOUT:30s}
{{- if .JobRunrUsesSql}}

  # JobRunr storage datasource (separate from application data for production flexibility)
  #
  # SECURITY WARNING: The credentials below are for LOCAL DEVELOPMENT ONLY.
  # For production, override via environment variables:
  # - SPRING_DATASOURCE_URL
  # - SPRING_DATASOURCE_USERNAME
  # - SPRING_DATASOURCE_PASSWORD
  datasource:
{{- if and (.HasModule "SQLDatastore") (eq .Database "postgresql")}}
    url: jdbc:postgresql://localhost:5433/{{.ProjectName}}
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
{{- else if and (.HasModule "SQLDatastore") (eq .Database "mysql")}}
    url: jdbc:mysql://localhost:3307/{{.ProjectNameSnake}}?useSSL=true&requireSSL=true
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
{{- else}}
    # PostgreSQL fallback for JobRunr storage (Redis not supported in JobRunr 8+)
    url: jdbc:postgresql://localhost:5434/{{.ProjectName}}_jobs
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
{{- end}}
    # HikariCP settings for JobRunr storage (separate from application pool)
    # These are intentionally smaller since JobRunr has modest connection needs
    hikari:
      maximum-pool-size: 5
      minimum-idle: 2
      connection-timeout: 30000
{{- end}}
{{- if .JobRunrUsesMongoDB}}

  # JobRunr MongoDB storage configuration
  # By default, this uses the same MongoDB as your application data.
  # In production, you may want a separate database for job metadata.
  #
  # SECURITY WARNING: This URI has no authentication for LOCAL DEVELOPMENT.
  # For production, override via environment variable:
  # - SPRING_DATA_MONGODB_URI=mongodb://user:pass@host:27017/dbname?authSource=admin
  #
  # Note: This config is duplicated from NoSQLDatastore intentionally so that
  # the Worker module can run independently and be configured separately.
  data:
    mongodb:
      uri: ${SPRING_DATA_MONGODB_URI:mongodb://localhost:27017/{{.ProjectName}}}
{{- end}}

# Server configuration (for actuator health endpoints)
server:
  port: 8081
  shutdown: graceful

# Management/Actuator endpoints
management:
  server:
    port: 8082
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true
      show-details: when_authorized
    prometheus:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

# JobRunr Configuration
jobrunr:
  # Enable the background job server (processes jobs)
  background-job-server:
    enabled: true
    # Poll interval in seconds (minimum 5, lower = faster job pickup, higher database load)
    poll-interval-in-seconds: 5
    # Number of worker threads (default: 2x CPU cores)
    # worker-count: 4
  # JobRunr Dashboard (http://localhost:8000)
  # WARNING: The dashboard has no authentication by default!
  # For production, either:
  # 1. Disable the dashboard (enabled: false)
  # 2. Use a reverse proxy with authentication
  # 3. Use JobRunr Pro with built-in authentication
  # See: https://www.jobrunr.io/en/guides/authentication/basic-authentication/
  dashboard:
    enabled: ${JOBRUNR_DASHBOARD_ENABLED:true}
    port: ${JOBRUNR_DASHBOARD_PORT:8000}
  # Job configuration
  jobs:
    # Default number of retries (with exponential backoff)
    default-number-of-retries: 10
  # Database configuration
  database:
    # Skip database creation (set to false to auto-create tables)
    skip-create: false
{{- if .JobRunrUsesSql}}
    # Use SQL storage
    type: sql
{{- else if .JobRunrUsesMongoDB}}
    # Use MongoDB storage
    type: mongodb
{{- end}}

# Logging
logging:
  level:
    root: INFO
    {{.GroupID}}.worker: DEBUG
    org.jobrunr: INFO
