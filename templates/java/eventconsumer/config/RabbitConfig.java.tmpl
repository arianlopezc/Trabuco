package {{.GroupID}}.eventconsumer.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.listener.RabbitListenerContainerFactory;
import org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer;
import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * RabbitMQ consumer configuration.
 *
 * <p>Configures the RabbitMQ listener container factory with JSON message
 * conversion and appropriate error handling.</p>
 */
@Configuration
public class RabbitConfig {

    /**
     * JSON message converter using Jackson.
     *
     * <p>Automatically deserializes JSON messages to Java objects
     * based on type information in message headers.</p>
     */
    @Bean
    public Jackson2JsonMessageConverter jsonMessageConverter(ObjectMapper objectMapper) {
        return new Jackson2JsonMessageConverter(objectMapper);
    }

    /**
     * RabbitMQ listener container factory.
     *
     * <p>Configures:
     * <ul>
     *   <li>3 concurrent consumers (min)</li>
     *   <li>10 max concurrent consumers</li>
     *   <li>Rejected messages are NOT requeued (send to DLX if configured)</li>
     * </ul>
     * </p>
     *
     * <p>For failed messages, configure a Dead Letter Exchange (DLX) on your queue:
     * <pre>
     * x-dead-letter-exchange: dlx.placeholder
     * x-dead-letter-routing-key: placeholder.dlq
     * </pre>
     * </p>
     */
    @Bean
    public RabbitListenerContainerFactory<SimpleMessageListenerContainer> rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory,
            Jackson2JsonMessageConverter converter) {
        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        factory.setMessageConverter(converter);
        factory.setConcurrentConsumers(3);
        factory.setMaxConcurrentConsumers(10);
        factory.setDefaultRequeueRejected(false); // Don't requeue failed messages
        return factory;
    }
}
