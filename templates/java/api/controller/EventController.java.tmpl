package {{.GroupID}}.api.controller;

import {{.GroupID}}.events.EventPublisher;
import {{.GroupID}}.model.events.PlaceholderCreatedEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;
import java.util.UUID;

/**
 * Example controller demonstrating event publishing.
 *
 * <p>This controller shows how to publish events to {{if .UsesKafka}}Kafka{{else if .UsesRabbitMQ}}RabbitMQ{{end}}
 * that will be consumed by the EventConsumer module.</p>
 *
 * <p>Example request:
 * <pre>
 * POST /api/events/placeholder
 * Content-Type: application/json
 *
 * {
 *   "name": "Example Placeholder"
 * }
 * </pre>
 * </p>
 */
@RestController
@RequestMapping("/api/events")
public class EventController {

    private static final Logger logger = LoggerFactory.getLogger(EventController.class);

    private final EventPublisher eventPublisher;

    public EventController(EventPublisher eventPublisher) {
        this.eventPublisher = eventPublisher;
    }

    /**
     * Publishes a PlaceholderCreatedEvent.
     *
     * <p>The event will be processed by the PlaceholderEventListener
     * in the EventConsumer module.</p>
     *
     * @param request Request containing the placeholder name
     * @return Response with the generated event ID
     */
    @PostMapping("/placeholder")
    public ResponseEntity<Map<String, String>> publishPlaceholderEvent(
            @RequestBody Map<String, String> request) {

        String name = request.getOrDefault("name", "Unnamed");
        String entityId = UUID.randomUUID().toString();

        PlaceholderCreatedEvent event = PlaceholderCreatedEvent.create(entityId, name);

        logger.info("Publishing PlaceholderCreatedEvent: entityId={}, name={}", entityId, name);
        eventPublisher.publish(event);

        return ResponseEntity.accepted().body(Map.of(
            "eventId", event.eventId(),
            "entityId", entityId,
            "message", "Event published successfully"
        ));
    }
}
