package {{.GroupID}}.mcp;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.modelcontextprotocol.json.jackson.JacksonMcpJsonMapper;
import io.modelcontextprotocol.server.McpServer;
import io.modelcontextprotocol.server.McpSyncServer;
import io.modelcontextprotocol.server.transport.StdioServerTransportProvider;
import io.modelcontextprotocol.spec.McpSchema;
import {{.GroupID}}.mcp.tools.BuildTools;
import {{.GroupID}}.mcp.tools.ProjectTools;
import {{.GroupID}}.mcp.tools.TestTools;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * MCP Server for {{.ProjectName}}.
 *
 * <p>Provides AI tools for building, testing, and introspecting the project.
 * Uses STDIO transport for local integration with Claude Code and other MCP clients.
 *
 * <p>Usage: java -jar MCP/target/MCP-1.0-SNAPSHOT.jar
 *
 * <p>Register in Claude Code's mcp.json:
 * <pre>
 * {
 *   "mcpServers": {
 *     "{{.ProjectName}}": {
 *       "command": "java",
 *       "args": ["-jar", "MCP/target/MCP-1.0-SNAPSHOT.jar"]
 *     }
 *   }
 * }
 * </pre>
 */
public class McpServerApplication {

    private static final Logger log = LoggerFactory.getLogger(McpServerApplication.class);
    private static final String SERVER_NAME = "{{.ProjectName}}-mcp";
    private static final String SERVER_VERSION = "1.0.0";

    public static void main(String[] args) {
        log.info("Starting {} MCP Server v{}", SERVER_NAME, SERVER_VERSION);

        try {
            JacksonMcpJsonMapper jsonMapper = new JacksonMcpJsonMapper(new ObjectMapper());
            StdioServerTransportProvider transportProvider = new StdioServerTransportProvider(jsonMapper);

            McpSyncServer server = McpServer.sync(transportProvider)
                .serverInfo(SERVER_NAME, SERVER_VERSION)
                .capabilities(McpSchema.ServerCapabilities.builder()
                    .tools(true)      // Enable tool support
                    .logging()        // Enable logging support
                    .build())
                .build();

            // Register tools
            BuildTools.register(server);
            TestTools.register(server);
            ProjectTools.register(server);

            log.info("MCP Server started successfully. Listening on STDIO...");

            // Keep the server running until terminated
            Runtime.getRuntime().addShutdownHook(new Thread(() -> {
                log.info("Shutting down MCP Server...");
                server.close();
            }));

            // Block main thread
            Thread.currentThread().join();

        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.info("MCP Server interrupted");
        } catch (Exception e) {
            log.error("Failed to start MCP Server", e);
            System.exit(1);
        }
    }
}
