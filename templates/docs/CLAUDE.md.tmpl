# {{.ProjectName}}

Java multi-module Maven project using Spring Boot{{if .HasModule "SQLDatastore"}} with {{if eq .Database "postgresql"}}PostgreSQL{{else if eq .Database "mysql"}}MySQL{{end}}{{end}}{{if .HasModule "NoSQLDatastore"}}{{if .HasModule "SQLDatastore"}} and{{else}} with{{end}} {{if eq .NoSQLDatabase "mongodb"}}MongoDB{{else if eq .NoSQLDatabase "redis"}}Redis{{end}}{{end}}{{if .HasModule "Worker"}} and JobRunr for background jobs{{end}}{{if .HasModule "EventConsumer"}} and {{if .UsesKafka}}Kafka{{else if .UsesRabbitMQ}}RabbitMQ{{else if .UsesSQS}}AWS SQS{{else if .UsesPubSub}}GCP Pub/Sub{{end}} for event-driven processing{{end}}.

<!-- AI:QUALITY:START -->
## Code Quality (IMPORTANT)

**Before writing any Java code, read:** `.ai/prompts/JAVA_CODE_QUALITY.md`

This project enforces strict code quality standards. You MUST:

1. **Read the specification** before generating code
2. **Self-review** generated code against the specification
3. **Refactor** any violations immediately
4. **Verify** the code compiles and tests pass

### Quick Quality Checks

| Check | Requirement |
|-------|-------------|
| Method length | Max 30 lines, extract helpers |
| Loops vs Streams | Prefer streams for filter/map/collect |
| Optional | Return types only, use `map`/`orElse`, never `isPresent()+get()` |
| Records | Use for simple data, copy mutable fields |
| Pattern matching | Use `instanceof Type t`, switch expressions |
| Collections | Use `List.of()`, `.toList()`, no `Arrays.asList()` |
| Null handling | `Objects.requireNonNull` in constructors, Bean Validation on DTOs |
| Injection | Constructor injection only, all fields `private final` |

**Full specification:** `.ai/prompts/JAVA_CODE_QUALITY.md`
<!-- AI:QUALITY:END -->

<!-- AI:COMMANDS:START -->
## Build & Test Commands

| Command | Description |
|---------|-------------|
| `mvn clean compile` | Build all modules |
| `mvn test` | Run all tests |
| `mvn clean package` | Package all modules |
{{- if .HasModule "API"}}
| `cd API && mvn spring-boot:run` | Start API server (port 8080) |
{{- end}}
{{- if .HasModule "Worker"}}
| `cd Worker && mvn spring-boot:run` | Start Worker (port 8081) |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| `cd EventConsumer && mvn spring-boot:run` | Start EventConsumer (port 8083) |
{{- end}}
| `mvn spotless:apply` | Auto-format all Java files |
| `mvn spotless:check` | Check formatting (CI) |
| `mvn enforcer:enforce` | Check dependency and version rules |
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}
| `docker-compose up -d` | Start infrastructure services |
{{- end}}
<!-- AI:COMMANDS:END -->
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}

**Docker:**
```bash
{{- if .HasModule "API"}}
docker build -f API/Dockerfile -t {{.ProjectName}}-api .
{{- end}}
{{- if .HasModule "Worker"}}
docker build -f Worker/Dockerfile -t {{.ProjectName}}-worker .
{{- end}}
{{- if .HasModule "EventConsumer"}}
docker build -f EventConsumer/Dockerfile -t {{.ProjectName}}-eventconsumer .
{{- end}}
```
{{- end}}

<!-- AI:PATTERNS:START -->
## Code Patterns

| Pattern | Description |
|---------|-------------|
| Entities | Use `ImmutableX.builder()...build()` pattern with `@Value.Immutable` |
| DTOs | Use `@Value.Immutable` with `@JsonSerialize/@JsonDeserialize` |
{{- if .HasModule "Shared"}}
| Services | Inject repositories, add `@CircuitBreaker(name = "default")` on external calls |
{{- end}}
{{- if .HasModule "API"}}
| Controllers | Use `@RestController`, return `ImmutableXResponse` types |
{{- end}}
{{- if .HasModule "SQLDatastore"}}
| SQL Records | Use Java records at repository boundary, convert to Immutables immediately |
| Flyway Migrations | Use `V{number}__{description}.sql`, never modify existing migrations |
{{- end}}
{{- if .HasModule "NoSQLDatastore"}}
| NoSQL Documents | Use Java records at repository boundary, convert to Immutables immediately |
{{- end}}
{{- if .HasModule "Worker"}}
| Job Handlers | Annotate with `@Job(name = "Description: %0")`, keep idempotent |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Event Listeners | Use sealed interfaces for event contracts, handle DLT for failures |
{{- end}}
<!-- AI:PATTERNS:END -->

<!-- AI:FILES:START -->
## File Locations

| Purpose | Location |
|---------|----------|
{{- if .HasModule "Model"}}
| Entities | `Model/src/main/java/.../model/entities/` |
| DTOs | `Model/src/main/java/.../model/dto/` |
| Events (schemas) | `Model/src/main/java/.../model/events/` |
| Jobs (schemas) | `Model/src/main/java/.../model/jobs/` |
{{- end}}
{{- if .HasModule "SQLDatastore"}}
| SQL Repositories | `SQLDatastore/src/main/java/.../sqldatastore/repository/` |
| SQL Migrations | `SQLDatastore/src/main/resources/db/migration/` |
{{- end}}
{{- if .HasModule "NoSQLDatastore"}}
| NoSQL Repositories | `NoSQLDatastore/src/main/java/.../nosqldatastore/repository/` |
{{- end}}
{{- if .HasModule "Shared"}}
| Services | `Shared/src/main/java/.../shared/service/` |
{{- end}}
{{- if .HasModule "API"}}
| Controllers | `API/src/main/java/.../api/controller/` |
| API Config | `API/src/main/java/.../api/config/` |
{{- end}}
{{- if .HasModule "Worker"}}
| Job Handlers | `Worker/src/main/java/.../worker/handler/` |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Event Listeners | `EventConsumer/src/main/java/.../eventconsumer/listener/` |
{{- end}}
<!-- AI:FILES:END -->

## Immutables

This project uses [Immutables](https://immutables.github.io/) for all DTOs and entities. This is a critical pattern — Claude must follow it.

**Rules:**
- Always use `ImmutableX` concrete types in method signatures, not interface types
- Always use builders: `ImmutablePlaceholder.builder()...build()`
- Never use `new` for Immutable objects
- Always add `@JsonSerialize` and `@JsonDeserialize` annotations
- Enums do NOT use Immutables

**Correct:**
```java
public ImmutablePlaceholder create(ImmutablePlaceholderRequest request) {
    return ImmutablePlaceholder.builder()
        .name(request.name())
        .build();
}
```

**Wrong:**
```java
public Placeholder create(PlaceholderRequest request) {  // interface type
    return new Placeholder(...);  // constructor
}
```
{{- if .HasModule "API"}}

## Exception Handling

`GlobalExceptionHandler` handles all common exceptions — do not add try-catch in controllers.
{{- end}}

## Configuration
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}

- Use `${ENV_VAR:default}` pattern in `application.yml` — never hardcode credentials
- Log format is in `logback-spring.xml`, log levels are in `application.yml` — do not mix these
- Default profile is `local` (colored console); other profiles use JSON logging
{{- end}}
{{- if .HasModule "Shared"}}
- Use `@CircuitBreaker(name = "default")` on methods calling external resources
{{- end}}
{{- if .HasModule "API"}}

## Observability

**Metrics (Prometheus):**
- All modules expose metrics at `/actuator/prometheus`
- Metrics configuration is in `application.yml` under `management.metrics`

**API Documentation (OpenAPI/Swagger):**
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- OpenAPI spec: `http://localhost:8080/api-docs`
- Configuration in `OpenAPIConfig.java` and `application.yml` under `springdoc`
- Disable with `SPRINGDOC_ENABLED=false`

**Correlation IDs:**
- `CorrelationIdFilter.java` adds `X-Correlation-ID` header to all requests
- IDs are included in logs via MDC and returned in response headers
- Pass existing ID in request header for distributed tracing

**Health Probes:**
- `/actuator/health` — Overall health
- `/actuator/health/readiness` — Kubernetes readiness
- `/actuator/health/liveness` — Kubernetes liveness

**Test Coverage:**
- JaCoCo reports at `<module>/target/site/jacoco/index.html` after `mvn test`
{{- end}}
{{- if or (.HasModule "SQLDatastore") (.HasModule "NoSQLDatastore")}}

## Testing

Repository tests use Testcontainers — Docker must be running.
{{- end}}

## Task Guides

For complex tasks, read the corresponding guide in `.ai/prompts/`:

| Task | Guide | When to Use |
|------|-------|-------------|
| **Code quality** | `.ai/prompts/JAVA_CODE_QUALITY.md` | Before/after writing ANY Java code |
| Add new entity | `.ai/prompts/add-entity.md` | Creating a new domain object |
{{- if .HasModule "API"}}
| Add REST endpoint | `.ai/prompts/add-endpoint.md` | Exposing new API functionality |
{{- end}}
{{- if .HasModule "Worker"}}
| Add background job | `.ai/prompts/add-job.md` | Async processing tasks |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Add event type | `.ai/prompts/add-event.md` | Event-driven features |
{{- end}}
| Extend project | `.ai/prompts/extending-the-project.md` | Adding auth, caching, pagination, etc. |

## Boundaries

This project does NOT include: authentication/authorization, frontend/UI, GraphQL, gRPC, WebSockets, Kubernetes manifests, or production database schemas. Placeholder entities should be replaced with real domain objects. For guidance on adding missing capabilities, see `.ai/prompts/extending-the-project.md`.

<!-- AI:CHECKPOINT:START -->
## Session Status

**Branch**: (not tracked yet)
**Working on**: (no active task)
**Tests**: (not run yet)

_Update `.ai/checkpoint.json` to track progress across sessions._
<!-- AI:CHECKPOINT:END -->

## Git

These files are local and already in `.gitignore`:
- `CLAUDE.local.md`, `.claude/settings.local.json` — personal Claude Code settings
- `*PLAN.md` — plan mode scratch files
