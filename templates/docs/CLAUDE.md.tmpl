{{- if .Frontmatter -}}
---
{{.Frontmatter}}---
{{end -}}
# {{.ProjectName}}

Java multi-module Maven project using Spring Boot{{if .HasModule "SQLDatastore"}} with {{if eq .Database "postgresql"}}PostgreSQL{{else if eq .Database "mysql"}}MySQL{{end}}{{end}}{{if .HasModule "NoSQLDatastore"}}{{if .HasModule "SQLDatastore"}} and{{else}} with{{end}} {{if eq .NoSQLDatabase "mongodb"}}MongoDB{{else if eq .NoSQLDatabase "redis"}}Redis{{end}}{{end}}{{if .HasModule "Worker"}} and JobRunr for background jobs{{end}}{{if .HasModule "EventConsumer"}} and {{if .UsesKafka}}Kafka{{else if .UsesRabbitMQ}}RabbitMQ{{else if .UsesSQS}}AWS SQS{{else if .UsesPubSub}}GCP Pub/Sub{{end}} for event-driven processing{{end}}.

## Code Quality (IMPORTANT)

**Code quality specification:** `{{.PromptsDir}}/JAVA_CODE_QUALITY.md`

This project enforces strict code quality standards. You MUST:

1. **Follow the specification** when generating code
2. **Self-review** generated code against the specification
3. **Refactor** any violations immediately
4. **Verify** the code compiles and tests pass

### Quick Quality Checks

| Check | Requirement |
|-------|-------------|
| Method length | Max 30 lines, extract helpers |
| Loops vs Streams | Prefer streams for filter/map/collect |
| Optional | Return types only, use `map`/`orElse`, never `isPresent()+get()` |
| Records | Use for simple data, copy mutable fields |
| Pattern matching | Use `instanceof Type t`, switch expressions |
| Collections | Use `List.of()`, `.toList()`, no `Arrays.asList()` |
| Null handling | `Objects.requireNonNull` in constructors, Bean Validation on DTOs |
| Injection | Constructor injection only, all fields `private final` |

## Build & Test Commands

| Command | Description |
|---------|-------------|
| `mvn clean compile` | Build all modules |
| `mvn test` | Run all tests |
| `mvn clean package` | Package all modules |
{{- if .HasModule "API"}}
| `cd API && mvn spring-boot:run` | Start API server (port 8080) |
{{- end}}
{{- if .HasModule "Worker"}}
| `cd Worker && mvn spring-boot:run` | Start Worker (port 8081) |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| `cd EventConsumer && mvn spring-boot:run` | Start EventConsumer (port 8083) |
{{- end}}
| `mvn spotless:apply` | Auto-format all Java files |
| `mvn spotless:check` | Check formatting (CI) |
| `mvn enforcer:enforce` | Check dependency and version rules |
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}
| `docker-compose up -d` | Start infrastructure services |
{{- end}}
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}

**Docker:**
```bash
{{- if .HasModule "API"}}
docker build -f API/Dockerfile -t {{.ProjectName}}-api .
{{- end}}
{{- if .HasModule "Worker"}}
docker build -f Worker/Dockerfile -t {{.ProjectName}}-worker .
{{- end}}
{{- if .HasModule "EventConsumer"}}
docker build -f EventConsumer/Dockerfile -t {{.ProjectName}}-eventconsumer .
{{- end}}
```
{{- end}}

## Module Dependencies

Dependency direction — modules may only import from modules they depend on:

```
{{- if .HasModule "Model"}}
Model              → (none)
{{- end}}
{{- if .HasModule "SQLDatastore"}}
SQLDatastore       → Model
{{- end}}
{{- if .HasModule "NoSQLDatastore"}}
NoSQLDatastore     → Model
{{- end}}
{{- if .HasModule "Shared"}}
Shared             → Model{{if .HasModule "SQLDatastore"}}, SQLDatastore{{end}}{{if .HasModule "NoSQLDatastore"}}, NoSQLDatastore{{end}}
{{- end}}
{{- if .HasModule "API"}}
API                → Model{{if .HasModule "Shared"}}, Shared{{end}}
{{- end}}
{{- if .HasModule "Worker"}}
Worker             → Model{{if .HasModule "Shared"}}, Shared{{end}}
{{- end}}
{{- if .HasModule "EventConsumer"}}
EventConsumer      → Model{{if .HasModule "Shared"}}, Shared{{end}}
{{- end}}
```
{{- if or (.HasModule "API") (or (.HasModule "Worker") (.HasModule "EventConsumer"))}}

Never import from API in Worker/EventConsumer or vice versa.
{{- end}}

## Code Patterns

| Pattern | Description |
|---------|-------------|
| Entities | Use `ImmutableX.builder()...build()` pattern with `@Value.Immutable` |
| DTOs | Use `@Value.Immutable` with `@JsonSerialize/@JsonDeserialize` |
{{- if .HasModule "Shared"}}
| Services | Inject repositories, add `@CircuitBreaker(name = "default")` on external calls |
{{- end}}
{{- if .HasModule "API"}}
| Controllers | Use `@RestController`, return `ImmutableXResponse` types |
{{- end}}
{{- if .HasModule "SQLDatastore"}}
| SQL Records | Use Java records at repository boundary, convert to Immutables immediately |
| Flyway Migrations | Use `V{number}__{description}.sql`, never modify existing migrations |
{{- end}}
{{- if .HasModule "NoSQLDatastore"}}
| NoSQL Documents | Use Java records at repository boundary, convert to Immutables immediately |
{{- end}}
{{- if .HasModule "Worker"}}
| Job Handlers | Annotate with `@Job(name = "Description: %0")`, keep idempotent |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Event Listeners | Use sealed interfaces for event contracts, handle DLT for failures |
{{- end}}

## File Locations

Paths below use `{{.PackagePath}}/` as the package directory.

| Purpose | Location |
|---------|----------|
{{- if .HasModule "Model"}}
| Entities | `Model/src/main/java/{{.PackagePath}}/model/entities/` |
| DTOs | `Model/src/main/java/{{.PackagePath}}/model/dto/` |
| Events (schemas) | `Model/src/main/java/{{.PackagePath}}/model/events/` |
| Jobs (schemas) | `Model/src/main/java/{{.PackagePath}}/model/jobs/` |
{{- end}}
{{- if .HasModule "SQLDatastore"}}
| SQL Repositories | `SQLDatastore/src/main/java/{{.PackagePath}}/sqldatastore/repository/` |
| SQL Migrations | `SQLDatastore/src/main/resources/db/migration/` |
{{- end}}
{{- if .HasModule "NoSQLDatastore"}}
| NoSQL Repositories | `NoSQLDatastore/src/main/java/{{.PackagePath}}/nosqldatastore/repository/` |
{{- end}}
{{- if .HasModule "Shared"}}
| Services | `Shared/src/main/java/{{.PackagePath}}/shared/service/` |
{{- end}}
{{- if .HasModule "API"}}
| Controllers | `API/src/main/java/{{.PackagePath}}/api/controller/` |
| API Config | `API/src/main/java/{{.PackagePath}}/api/config/` |
{{- end}}
{{- if .HasModule "Worker"}}
| Job Handlers | `Worker/src/main/java/{{.PackagePath}}/worker/handler/` |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Event Listeners | `EventConsumer/src/main/java/{{.PackagePath}}/eventconsumer/listener/` |
{{- end}}

## Immutables

This project uses [Immutables](https://immutables.github.io/) for all DTOs and entities. This is a critical pattern that must always be followed.

**Rules:**
- Always use `ImmutableX` concrete types in method signatures, not interface types
- Always use builders: `ImmutablePlaceholder.builder()...build()`
- Never use `new` for Immutable objects
- Always add `@JsonSerialize` and `@JsonDeserialize` annotations
- Enums do NOT use Immutables

**Correct:**
```java
public ImmutablePlaceholder create(ImmutablePlaceholderRequest request) {
    return ImmutablePlaceholder.builder()
        .name(request.name())
        .build();
}
```

**Wrong:**
```java
public Placeholder create(PlaceholderRequest request) {  // interface type
    return new Placeholder(...);  // constructor
}
```
{{- if .HasModule "API"}}

## Exception Handling

`GlobalExceptionHandler` handles all common exceptions — do not add try-catch in controllers.
{{- end}}

## Configuration
{{- if or (or (.HasModule "API") (.HasModule "Worker")) (.HasModule "EventConsumer")}}

- Use `${ENV_VAR:default}` pattern in `application.yml` — never hardcode credentials
- Log format is in `logback-spring.xml`, log levels are in `application.yml` — do not mix these
- Default profile is `local` (colored console); other profiles use JSON logging
{{- end}}
{{- if .HasModule "Shared"}}
- Use `@CircuitBreaker(name = "default")` on methods calling external resources
{{- end}}
{{- if .HasModule "API"}}

## Observability

**Metrics (Prometheus):**
- All modules expose metrics at `/actuator/prometheus`
- Metrics configuration is in `application.yml` under `management.metrics`

**API Documentation (OpenAPI/Swagger):**
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- OpenAPI spec: `http://localhost:8080/api-docs`
- Configuration in `OpenAPIConfig.java` and `application.yml` under `springdoc`
- Disable with `SPRINGDOC_ENABLED=false`

**Correlation IDs:**
- `CorrelationIdFilter.java` adds `X-Correlation-ID` header to all requests
- IDs are included in logs via MDC and returned in response headers
- Pass existing ID in request header for distributed tracing

**Health Probes:**
- `/actuator/health` — Overall health
- `/actuator/health/readiness` — Kubernetes readiness
- `/actuator/health/liveness` — Kubernetes liveness

**Test Coverage:**
- JaCoCo reports at `<module>/target/site/jacoco/index.html` after `mvn test`
{{- end}}

## Testing
{{- if or (.HasModule "SQLDatastore") (.HasModule "NoSQLDatastore")}}

Repository tests use Testcontainers — Docker must be running.
{{- end}}

**Workflow**: Write tests BEFORE implementation. One test at a time.

| Rule | Description |
|------|-------------|
| Write test first | Write a failing test before writing any implementation code |
| One at a time | Do not write all tests in bulk — one test, one implementation cycle |
| Fix code, not tests | If a test fails, fix the production code. Never modify tests to pass |
| Test behavior | Test through public interfaces, not private methods or internals |
| Naming | `should_ExpectedBehavior_When_Condition` with Given/When/Then comments |

**Full testing standards**: `{{.PromptsDir}}/JAVA_CODE_QUALITY.md` (Section 7)
**Comprehensive testing guide**: `{{.PromptsDir}}/testing-guide.md`

## Task Guides

For complex tasks, follow the corresponding guide in `{{.PromptsDir}}/`:

| Task | Guide | When to Use |
|------|-------|-------------|
| **Code quality** | `{{.PromptsDir}}/JAVA_CODE_QUALITY.md` | Before/after writing ANY Java code |
| Add new entity | `{{.PromptsDir}}/add-entity.md` | Creating a new domain object |
{{- if .HasModule "API"}}
| Add REST endpoint | `{{.PromptsDir}}/add-endpoint.md` | Exposing new API functionality |
{{- end}}
{{- if .HasModule "Worker"}}
| Add background job | `{{.PromptsDir}}/add-job.md` | Async processing tasks |
{{- end}}
{{- if .HasModule "EventConsumer"}}
| Add event type | `{{.PromptsDir}}/add-event.md` | Event-driven features |
{{- end}}
| Extend project | `{{.PromptsDir}}/extending-the-project.md` | Adding auth, caching, pagination, etc. |
| **Testing guide** | `{{.PromptsDir}}/testing-guide.md` | Writing tests for any module |

## Boundaries

This project does NOT include: authentication/authorization, frontend/UI, GraphQL, gRPC, WebSockets, Kubernetes manifests, or production database schemas. Placeholder entities should be replaced with real domain objects. For guidance on adding missing capabilities, see `{{.PromptsDir}}/extending-the-project.md`.

## Git

These files are local and already in `.gitignore`:
- Agent-specific local settings (e.g. `CLAUDE.local.md`, `.claude/settings.local.json`)
- Plan mode scratch files (`*PLAN.md`)
