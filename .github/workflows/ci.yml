name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build
        run: go build -v ./cmd/trabuco

      - name: Run Go tests
        run: go test -v ./...

      - name: Upload CLI binary
        uses: actions/upload-artifact@v4
        with:
          name: trabuco-cli
          path: trabuco
          retention-days: 1

  test-generated-project:
    name: Test Generated Project
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: trabuco-cli

      - name: Make CLI executable
        run: chmod +x ./trabuco

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate project with all modules
        run: |
          mkdir -p test-output
          cd test-output
          ../trabuco init \
            --name=test-project \
            --group-id=com.test.project \
            --modules=Model,SQLDatastore,Shared,API \
            --database=postgresql

      - name: Display generated structure
        run: |
          echo "Generated project structure:"
          find test-output/test-project -type f -name "*.java" -o -name "*.xml" -o -name "*.yml" | head -30

      - name: Build generated project
        working-directory: test-output/test-project
        run: mvn clean compile -B

      - name: Run generated project tests (skip integration)
        working-directory: test-output/test-project
        run: mvn test -B -DskipITs -Dspring.profiles.active=test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test

  test-comprehensive-project:
    name: Test Comprehensive Project (All Modules)
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
        ports:
          - 2181:2181

      kafka:
        image: confluentinc/cp-kafka:7.5.0
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092

    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: trabuco-cli

      - name: Make CLI executable
        run: chmod +x ./trabuco

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate comprehensive project
        run: |
          mkdir -p test-comprehensive
          cd test-comprehensive
          ../trabuco init \
            --name=full-project \
            --group-id=com.test.fullproject \
            --modules=Model,SQLDatastore,Shared,API,Worker,EventConsumer \
            --database=postgresql \
            --message-broker=kafka

      - name: Display generated structure
        run: |
          echo "Generated project structure:"
          find test-comprehensive/full-project -type f \( -name "*.java" -o -name "pom.xml" \) | head -50

      - name: Build and install all modules
        working-directory: test-comprehensive/full-project
        run: mvn clean install -B -DskipTests
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test

      - name: Run unit tests
        working-directory: test-comprehensive/full-project
        run: mvn test -B -DskipITs
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test

      - name: Verify API module starts
        working-directory: test-comprehensive/full-project/API
        run: |
          timeout 60 mvn spring-boot:run -Dspring-boot.run.profiles=local &
          API_PID=$!
          sleep 30
          curl -sf http://localhost:8080/actuator/health || (kill $API_PID 2>/dev/null; exit 1)
          kill $API_PID 2>/dev/null || true
          echo "API started successfully"
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test

      - name: Verify Worker module starts
        working-directory: test-comprehensive/full-project/Worker
        run: |
          timeout 60 mvn spring-boot:run -Dspring-boot.run.profiles=local &
          WORKER_PID=$!
          sleep 30
          curl -sf http://localhost:8082/actuator/health || (kill $WORKER_PID 2>/dev/null; exit 1)
          kill $WORKER_PID 2>/dev/null || true
          echo "Worker started successfully"
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          ORG_JOBRUNR_BACKGROUND_JOB_SERVER_ENABLED: "true"
          ORG_JOBRUNR_DASHBOARD_ENABLED: "false"

      - name: Verify EventConsumer module starts
        working-directory: test-comprehensive/full-project/EventConsumer
        run: |
          timeout 60 mvn spring-boot:run -Dspring-boot.run.profiles=local &
          CONSUMER_PID=$!
          sleep 30
          curl -sf http://localhost:8084/actuator/health || (kill $CONSUMER_PID 2>/dev/null; exit 1)
          kill $CONSUMER_PID 2>/dev/null || true
          echo "EventConsumer started successfully"
        env:
          SPRING_KAFKA_BOOTSTRAP_SERVERS: localhost:9092

  test-minimal-project:
    name: Test Minimal Project (Model only)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: trabuco-cli

      - name: Make CLI executable
        run: chmod +x ./trabuco

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate minimal project
        run: |
          mkdir -p test-minimal
          cd test-minimal
          ../trabuco init \
            --name=minimal-project \
            --group-id=com.minimal.project \
            --modules=Model \
            --database=none

      - name: Build minimal project
        working-directory: test-minimal/minimal-project
        run: mvn clean compile test -B

  test-mcp-server:
    name: Test MCP Server Module
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: trabuco-cli

      - name: Make CLI executable
        run: chmod +x ./trabuco

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate project with MCP module
        run: |
          mkdir -p test-mcp
          cd test-mcp
          ../trabuco init \
            --name=mcp-project \
            --group-id=com.test.mcp \
            --modules=Model,MCP \
            --skip-build

      - name: Display MCP module structure
        run: |
          echo "MCP module structure:"
          find test-mcp/mcp-project/MCP -type f -name "*.java" -o -name "*.xml"
          echo ""
          echo "=== MCP Configuration Files ==="
          echo "Claude Code (.mcp.json):"
          cat test-mcp/mcp-project/.mcp.json
          echo ""
          echo "Cursor (.cursor/mcp.json):"
          cat test-mcp/mcp-project/.cursor/mcp.json
          echo ""
          echo "VS Code (.vscode/mcp.json):"
          cat test-mcp/mcp-project/.vscode/mcp.json
          echo ""
          echo "MCP README exists:"
          ls -la test-mcp/mcp-project/MCP/README.md

      - name: Build MCP module
        working-directory: test-mcp/mcp-project
        run: mvn clean package -B -DskipTests

      - name: Verify MCP JAR exists
        run: |
          JAR_PATH="test-mcp/mcp-project/MCP/target/MCP-1.0-SNAPSHOT.jar"
          if [ ! -f "$JAR_PATH" ]; then
            echo "ERROR: MCP JAR not found at $JAR_PATH"
            exit 1
          fi
          echo "MCP JAR found: $(ls -lh $JAR_PATH)"

      - name: Verify MCP config files for all agents
        run: |
          cd test-mcp/mcp-project
          ERRORS=0

          # Claude Code
          if [ -f ".mcp.json" ]; then
            echo "✓ .mcp.json (Claude Code)"
          else
            echo "✗ .mcp.json MISSING"
            ERRORS=$((ERRORS + 1))
          fi

          # Cursor
          if [ -f ".cursor/mcp.json" ]; then
            echo "✓ .cursor/mcp.json (Cursor)"
          else
            echo "✗ .cursor/mcp.json MISSING"
            ERRORS=$((ERRORS + 1))
          fi

          # VS Code / Copilot
          if [ -f ".vscode/mcp.json" ]; then
            echo "✓ .vscode/mcp.json (VS Code/Copilot)"
          else
            echo "✗ .vscode/mcp.json MISSING"
            ERRORS=$((ERRORS + 1))
          fi

          # MCP README
          if [ -f "MCP/README.md" ]; then
            echo "✓ MCP/README.md (Setup instructions)"
          else
            echo "✗ MCP/README.md MISSING"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "ERROR: $ERRORS MCP config files missing"
            exit 1
          fi

          echo "All MCP configuration files verified ✓"

      - name: Test MCP server initialization
        working-directory: test-mcp/mcp-project
        run: |
          # Create init request file
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}' > /tmp/mcp-init.json

          # Run MCP server with input, capture stdout
          # Keep stdin open for 3s so the server can flush its response before transport closes
          (cat /tmp/mcp-init.json; sleep 3) | timeout 10 java -jar MCP/target/MCP-1.0-SNAPSHOT.jar > /tmp/mcp-stdout.txt 2>/dev/null || true

          # Check log file for the response (more reliable)
          cat mcp-server.log 2>/dev/null | tee /tmp/mcp-log.txt || true

          echo "=== MCP Server stdout ==="
          cat /tmp/mcp-stdout.txt

          # Verify initialize response in stdout
          if grep -q '"id":1.*"result".*"serverInfo"' /tmp/mcp-stdout.txt; then
            echo "✓ Initialize response found in stdout"
          elif grep -q 'mcp-project-mcp' /tmp/mcp-stdout.txt; then
            echo "✓ Server name found in stdout"
          else
            echo "ERROR: Initialize response not found"
            echo "=== Log file ==="
            cat /tmp/mcp-log.txt
            exit 1
          fi

          # Verify server name is correct
          if grep -q 'mcp-project-mcp' /tmp/mcp-stdout.txt; then
            echo "✓ Server name 'mcp-project-mcp' verified"
          else
            echo "ERROR: Server name not found"
            exit 1
          fi

          echo "MCP server initialized successfully"

      - name: Test MCP tools registration
        working-directory: test-mcp/mcp-project
        run: |
          # Run MCP server briefly and check tool notifications
          # Keep stdin open for 3s so the server can flush its response before transport closes
          (echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'; sleep 3) | \
            timeout 10 java -jar MCP/target/MCP-1.0-SNAPSHOT.jar > /tmp/mcp-tools-stdout.txt 2>/dev/null || true

          echo "=== MCP Tool Notifications ==="
          cat /tmp/mcp-tools-stdout.txt

          # Count tool notifications (each tool triggers a list_changed notification)
          TOOL_COUNT=$(grep -c 'notifications/tools/list_changed' /tmp/mcp-tools-stdout.txt || echo "0")
          echo "Tool notifications: $TOOL_COUNT"

          # We expect 9 tools: build, package, clean, test, test-single, list-modules, list-entities, get-config, project-info
          if [ "$TOOL_COUNT" -ge 9 ]; then
            echo "✓ All 9 tools registered (found $TOOL_COUNT notifications)"
          else
            echo "ERROR: Expected 9 tool notifications, got $TOOL_COUNT"
            exit 1
          fi

          # Verify the tools capability is enabled
          if grep -q '"tools"' /tmp/mcp-tools-stdout.txt; then
            echo "✓ Tools capability enabled"
          else
            echo "ERROR: Tools capability not found"
            exit 1
          fi

          echo "MCP tools registration verified successfully"

  test-ai-agents:
    name: Test AI Agent Files Generation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binary
        uses: actions/download-artifact@v4
        with:
          name: trabuco-cli

      - name: Make CLI executable
        run: chmod +x ./trabuco

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Generate project with all AI agents
        run: |
          mkdir -p test-ai
          cd test-ai
          ../trabuco init \
            --name=ai-project \
            --group-id=com.test.ai \
            --modules=Model,Shared,API,Worker,EventConsumer,SQLDatastore \
            --database=postgresql \
            --message-broker=kafka \
            --ai-agents=claude,cursor,copilot,windsurf,cline \
            --skip-build

      - name: Verify all AI agent files exist
        working-directory: test-ai/ai-project
        run: |
          ERRORS=0

          # Check agent instruction files
          echo "Checking AI agent instruction files..."
          for file in "CLAUDE.md" ".cursor/rules/project.mdc" ".github/copilot-instructions.md" ".windsurf/rules/project.md" ".clinerules/project.md"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists ($(wc -l < "$file") lines)"
            else
              echo "  ✗ $file MISSING"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check AI context directory
          echo ""
          echo "Checking .ai directory structure..."
          for file in ".ai/README.md" ".ai/checkpoint.json"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists"
            else
              echo "  ✗ $file MISSING"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check prompts (should exist based on modules selected)
          echo ""
          echo "Checking .ai/prompts directory..."
          for file in ".ai/prompts/add-entity.md" ".ai/prompts/add-endpoint.md" ".ai/prompts/add-job.md" ".ai/prompts/add-event.md"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists"
            else
              echo "  ✗ $file MISSING"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "ERROR: $ERRORS files missing"
            exit 1
          fi

          echo ""
          echo "All AI agent files verified successfully"

      - name: Verify AI agent files share core content
        working-directory: test-ai/ai-project
        run: |
          # Each agent file has different frontmatter/paths but must share core content
          ERRORS=0
          CORE_PATTERNS=("Module Dependencies" "mvn clean compile" "Constructor injection")

          for file in "CLAUDE.md" ".cursor/rules/project.mdc" ".github/copilot-instructions.md" ".windsurf/rules/project.md" ".clinerules/project.md"; do
            for pattern in "${CORE_PATTERNS[@]}"; do
              if ! grep -q "$pattern" "$file"; then
                echo "  ✗ $file missing core content: '$pattern'"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "ERROR: $ERRORS core content checks failed"
            exit 1
          fi

          echo "All AI agent files contain core content ✓"

      - name: Verify Claude Code dual-location files
        working-directory: test-ai/ai-project
        run: |
          # Claude Code auto-discovers .claude/rules/*.md — prompts should be copied there
          ERRORS=0
          for file in ".claude/rules/JAVA_CODE_QUALITY.md" ".claude/rules/testing-guide.md" ".claude/rules/add-entity.md" ".claude/rules/add-endpoint.md"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists"
            else
              echo "  ✗ $file MISSING"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "ERROR: $ERRORS Claude rules files missing"
            exit 1
          fi

          echo "All Claude Code dual-location files verified ✓"

      - name: Verify prompts contain module-specific content
        working-directory: test-ai/ai-project
        run: |
          echo "Checking prompt content..."

          # add-entity should mention Immutables
          if grep -q "Immutables" .ai/prompts/add-entity.md; then
            echo "  ✓ add-entity.md mentions Immutables"
          else
            echo "  ✗ add-entity.md missing Immutables reference"
            exit 1
          fi

          # add-endpoint should mention REST/controller
          if grep -q -i "controller\|endpoint\|REST" .ai/prompts/add-endpoint.md; then
            echo "  ✓ add-endpoint.md mentions controller/endpoint"
          else
            echo "  ✗ add-endpoint.md missing controller reference"
            exit 1
          fi

          # add-job should mention JobRunr
          if grep -q "JobRunr\|JobRequest" .ai/prompts/add-job.md; then
            echo "  ✓ add-job.md mentions JobRunr"
          else
            echo "  ✗ add-job.md missing JobRunr reference"
            exit 1
          fi

          # add-event should mention the message broker (kafka)
          if grep -q -i "kafka\|event\|listener" .ai/prompts/add-event.md; then
            echo "  ✓ add-event.md mentions kafka/event"
          else
            echo "  ✗ add-event.md missing broker reference"
            exit 1
          fi

          echo ""
          echo "All prompts contain expected module-specific content ✓"
